(function(){var Box,DICT_FLAG,DictFlag,HIDDEN_VAR_PREFIX,TreeTin,VarTin,Variable,bind,bind_tins,box,boxit,extern,g_hidden_var_counter,get_tin,isHiddenVar,map,str,toJson,types,unboxit,_unify;typeof module=="undefined"&&(window.unify={}),extern=function(name,o){return typeof module=="undefined"?window.unify[name]=o:module.exports[name]=o},str=function(o){return typeof o=="undefined"?"undefined":o===null?"null":o.toString()},map=function(arr,func){var i,_i,_len,_results;_results=[];for(_i=0,_len=arr.length;_i<_len;_i++)i=arr[_i],_results.push(func(i));return _results},types={isUndef:function(o){return typeof o=="undefined"},isBool:function(o){return typeof o=="boolean"},isArray:function(o){return o!=null&&Array.isArray(o)},isStr:function(o){return typeof o=="string"},isNum:function(o){return typeof o=="number"},isObj:function(o){return o!==null&&!types.isArray(o)&&typeof o=="object"},isValueType:function(o){return types.isBool(o)||types.isStr(o)||types.isNum(o)},isFunc:function(o){return!!(o&&o.constructor&&o.call&&o.apply)}},toJson=function(elem){var e;return types.isArray(elem)?"["+map(elem,function(i){return toJson(i)}).join(",")+"]":elem instanceof Box||elem instanceof VarTin||elem instanceof TreeTin||elem instanceof Variable||elem instanceof DictFlag?str(elem):types.isObj(elem)?"{"+function(){var _results;_results=[];for(e in elem)_results.push(e+":"+toJson(elem[e]));return _results}().join(",")+"}":types.isStr(elem)?'"'+elem+'"':str(elem)},DictFlag=function(){function DictFlag(){}return DictFlag.prototype.toString=function(){return"new DictFlag()"},DictFlag}(),DICT_FLAG=new DictFlag,Box=function(){function Box(v){if(!types.isValueType(v)&&v!==null)throw"Can only box value types, not "+toJson(v);this.value=v}return Box.prototype.toString=function(){return"new Box("+toJson(this.value)+")"},Box}(),g_hidden_var_counter=1,HIDDEN_VAR_PREFIX="__B3qgfO__",isHiddenVar=function(name){return name.slice(0,HIDDEN_VAR_PREFIX.length)===HIDDEN_VAR_PREFIX},Variable=function(){function Variable(name,typeFunc){this.typeFunc=typeFunc!=null?typeFunc:null,name==="_"?(this.name=HIDDEN_VAR_PREFIX+g_hidden_var_counter,g_hidden_var_counter+=1):this.name=name}return Variable.prototype.isHiddenVar=function(){return isHiddenVar(this.name)},Variable.prototype.toString=function(){return"variable("+toJson(this.name)+")"},Variable}(),TreeTin=function(){function TreeTin(node,varlist){this.node=node,this.varlist=varlist,this.changes=[]}return TreeTin.prototype.toString=function(){return"new TreeTin("+toJson(this.node)+", "+toJson(this.varlist)+")"},TreeTin.prototype.get=function(varName){var vartin;vartin=this.varlist[varName];if(!vartin)throw"Variable "+varName+" not in this tin";return vartin=vartin.endOfChain(),vartin.node?unboxit(vartin.node,vartin.varlist):new Variable(vartin.name)},TreeTin.prototype.getAll=function(){var j,key;j={};for(key in this.varlist)isHiddenVar(key)||(j[key]=this.get(key));return j},TreeTin.prototype.unbox=function(){return unboxit(this.node,this.varlist)},TreeTin.prototype.unify=function(tin){var changes,success;return changes=[],tin instanceof TreeTin||(tin=box(tin)),success=_unify(this.node,this.varlist,tin.node,tin.varlist,changes),success?(this.changes.push.apply(this.changes,changes),this.changes.push.apply(tin.changes,changes),[this,tin]):null},TreeTin.prototype.bind=function(varName,expr){var changes,vartin;return vartin=this.varlist[varName].endOfChain(),vartin.isfree()?(expr instanceof TreeTin||(expr=box(expr)),changes=[],bind(vartin,expr.node,expr.varlist,changes)?(this.changes.push.apply(this.changes,changes),this.changes.push.apply(expr.changes,changes),[this,expr]):null):null},TreeTin.prototype.rollback=function(){map(this.changes,function(change){return change()}),this.changes.splice(0,this.changes.length)},TreeTin}(),VarTin=function(){function VarTin(name,node,varlist,typeFunc){this.name=name,this.node=node!=null?node:null,this.varlist=varlist!=null?varlist:null,this.typeFunc=typeFunc!=null?typeFunc:null,this.chainlength=1}return VarTin.prototype.endOfChain=function(){var t;t=this;while(t.varlist instanceof VarTin)t=t.varlist;return t},VarTin.prototype.isfree=function(){var t;return t=this.endOfChain(),t.node===null&&t.varlist===null},VarTin.prototype.isHiddenVar=function(){return isHiddenVar(this.name)},VarTin.prototype.toString=function(){return"new VarTin("+toJson(this.name)+", "+toJson(this.node)+", "+toJson(this.varlist)+")"},VarTin.prototype.unbox=function(){return this.node?unboxit(this.node,this.varlist):new Variable(this.name)},VarTin}(),unboxit=function(tree,varlist){var e,hash,tin,_i,_len,_ref;if(types.isArray(tree)){if(tree.length>0&&tree[tree.length-1]===DICT_FLAG){hash=new Object,_ref=tree.slice(0,tree.length-1);for(_i=0,_len=_ref.length;_i<_len;_i++)e=_ref[_i],hash[unboxit(e[0],varlist)]=unboxit(e[1],varlist);return hash}return map(tree,function(i){return unboxit(i,varlist)})}if(tree instanceof Box)return tree.value;if(tree instanceof Variable){if(varlist!==void 0){try{tin=get_tin(varlist,tree)}catch(error){return tree}return tin.node!=null&&tin.varlist!=null?unboxit(tin.node,tin.varlist):tree}return tree}throw"Unrecognized type '"+typeof tree+"' in unbox."},boxit=function(elem,varlist){var a,key;if(elem instanceof Variable){if(varlist[elem.name]!=null)if(elem.typeFunc!=null&&varlist[elem.name].typeFunc!=null){if(elem.typeFunc!==varlist[elem.name].typeFunc)throw"A single variable can not be defined with two diffrent types!"}else elem.typeFunc!=null&&(varlist[elem.name].typeFunc=elem.typeFunc);else varlist[elem.name]=new VarTin(elem.name,null,null,elem.typeFunc);return elem}if(elem instanceof Box)return elem;if(types.isArray(elem))return map(elem,function(i){return boxit(i,varlist)});if(types.isObj(elem)){a=[];for(key in elem)a.push([boxit(key,varlist),boxit(elem[key],varlist)]);return a.push(DICT_FLAG),a.sort()}return types.isValueType(elem||elem===null)?new Box(elem):"Unrecognized type '"+typeof elem+"' in box."},box=function(elem){var tree,varlist;return elem instanceof TreeTin?elem:(varlist={},tree=boxit(elem,varlist),new TreeTin(tree,varlist))},get_tin=function(varlist,node){if(!node instanceof Variable)throw"Node must be a Variable to get_tin!";if((varlist!=null?varlist[node.name]:void 0)!=null)return varlist[node.name];throw"Couldn't find node "+node.name+" in varlist "+varlist+"!"},bind=function(t,node,varlist,changes){var called,unboxed;t=t.endOfChain();if(!t.isfree())return!1;if(t.typeFunc!==null){unboxed=unboxit(node,varlist);if(unboxed instanceof Variable&&Variable.typeFunc!==t.typeFunc)return!1;if(!t.typeFunc(unboxed))return!1}return t.node=node,t.varlist=varlist,called=!1,changes.push(function(){if(called)return;called=!0,t.node=null,t.varlist=null,t.chainlength=1}),!0},bind_tins=function(t1,t2,changes){return!t1.isfree()&&!t2.isfree()?!1:t1.isfree()&&!t2.isfree()?bind(t1,t2.node,t2.varlist,changes):!t1.isfree()&&t2.isfree()?bind(t2,t1.node,t1.varlist,changes):t2.chainlength<t1.chainlength?(t2.chainlength+=1,bind(t2,null,t1,changes)):(t1.chainlength+=1,bind(t1,null,t2,changes))},_unify=function(n1,v1,n2,v2,changes){var idx,num,t1,t2,_i,_len,_ref;changes==null&&(changes=[]);if(n1===void 0&&n2===void 0)return!0;if(n1===null&&n2===null)return!0;if(n1===null||n2===null)return!1;if(n1 instanceof Variable&&n2 instanceof Variable){t1=get_tin(v1,n1),t2=get_tin(v2,n2);if(!bind_tins(t1,t2,changes)&&!_unify(t1.node,t1.varlist,t2.node,t2.varlist,changes))return!1}else if(n1 instanceof Variable){t1=get_tin(v1,n1);if(!bind(t1,n2,v2,changes)&&!_unify(t1.node,t1.varlist,n2,v2,changes))return!1}else if(n2 instanceof Variable){t2=get_tin(v2,n2);if(!bind(t2,n1,v1,changes)&&!_unify(t2.node,t2.varlist,n1,v1,changes))return!1}else{if(n1 instanceof Box&&n2 instanceof Box&&types.isValueType(n1.value)&&types.isValueType(n2.value))return n1.value===n2.value;if(types.isArray(n1)&&types.isArray(n2)){if(n1.length!==n2.length)return!1;_ref=function(){var _j,_ref,_results;_results=[];for(num=_j=0,_ref=n1.length;0<=_ref?_j<=_ref:_j>=_ref;num=0<=_ref?++_j:--_j)_results.push(num);return _results}();for(_i=0,_len=_ref.length;_i<_len;_i++){idx=_ref[_i];if(!_unify(n1[idx],v1,n2[idx],v2,changes))return!1}}}return!0},extern("box",box),extern("variable",function(name,typeFunc){return new Variable(name,typeFunc)}),extern("TreeTin",TreeTin),extern("VarTin",VarTin),extern("Box",Box),extern("DICT_FLAG",DICT_FLAG),extern("toJson",toJson),extern("Variable",Variable),extern("types",types)}).call(this)