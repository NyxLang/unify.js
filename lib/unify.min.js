(function(){var n,t,e,i,r,u,o,s,l,a,f,c,h,p,y,d,v,g,m,b,w;"undefined"==typeof module&&(window.unify={}),c=function(n,t){return"undefined"==typeof module?window.unify[n]=t:module.exports[n]=t},v=function(n){return n===void 0?"undefined":null===n?"null":""+n},d=function(n,t){var e,i,r,u;for(u=[],i=0,r=n.length;r>i;i++)e=n[i],u.push(t(e));return u},m={isUndef:function(n){return n===void 0},isBool:function(n){return"boolean"==typeof n},isArray:function(n){return null!=n&&Array.isArray(n)},isStr:function(n){return"string"==typeof n},isNum:function(n){return"number"==typeof n},isObj:function(n){return null!==n&&!m.isArray(n)&&"object"==typeof n},isValueType:function(n){return m.isBool(n)||m.isStr(n)||m.isNum(n)},isFunc:function(n){return!!(n&&n.constructor&&n.call&&n.apply)}},g=function(t){var i;return m.isArray(t)?"["+d(t,function(n){return g(n)}).join(",")+"]":t instanceof n||t instanceof u||t instanceof r||t instanceof o||t instanceof e?v(t):m.isObj(t)?"{"+function(){var n;n=[];for(i in t)n.push(i+":"+g(t[i]));return n}().join(",")+"}":m.isStr(t)?'"'+t+'"':v(t)},e=function(){function n(){}return n.prototype.toString=function(){return"new DictFlag()"},n}(),t=new e,n=function(){function n(n){if(!m.isValueType(n)&&null!==n)throw"Can only box value types, not "+g(n);this.value=n}return n.prototype.toString=function(){return"new Box("+g(this.value)+")"},n}(),h=1,i="__HIDDEN__",y=function(n){return n.substring(0,i.length)===i},o=function(){function n(n,t){this.typeFunc=null!=t?t:null,"_"===n?(this.name=i+h,h+=1):this.name=n}return n.prototype.isHiddenVar=function(){return y(this.name)},n.prototype.toString=function(){return"variable("+g(this.name)+")"},n}(),r=function(){function n(n,t){this.node=n,this.varlist=t,this.changes=[]}return n.prototype.toString=function(){return"new TreeTin("+g(this.node)+", "+g(this.varlist)+")"},n.prototype.get=function(n){var t;if(t=this.varlist[n],!t)throw"Variable "+n+" not in this tin";return t=t.endOfChain(),t.node?b(t.node,t.varlist):new o(t.name)},n.prototype.getAll=function(){var n,t;n={};for(t in this.varlist)y(t)||(n[t]=this.get(t));return n},n.prototype.unbox=function(){return b(this.node,this.varlist)},n.prototype.unify=function(t){var e,i;return e=[],t instanceof n||(t=a(t)),i=w(this.node,this.varlist,t.node,t.varlist,e),i?(this.changes.push.apply(this.changes,e),this.changes.push.apply(t.changes,e),[this,t]):null},n.prototype.bind=function(t,e){var i,r;return r=this.varlist[t].endOfChain(),r.isfree()?(e instanceof n||(e=a(e)),i=[],s(r,e.node,e.varlist,i)?(this.changes.push.apply(this.changes,i),this.changes.push.apply(e.changes,i),[this,e]):null):null},n.prototype.rollback=function(){d(this.changes,function(n){return n()}),this.changes.splice(0,this.changes.length)},n}(),u=function(){function n(n,t,e,i){this.name=n,this.node=null!=t?t:null,this.varlist=null!=e?e:null,this.typeFunc=null!=i?i:null,this.chainlength=1}return n.prototype.endOfChain=function(){var t;for(t=this;t.varlist instanceof n;)t=t.varlist;return t},n.prototype.isfree=function(){var n;return n=this.endOfChain(),null===n.node&&null===n.varlist},n.prototype.isHiddenVar=function(){return y(this.name)},n.prototype.toString=function(){return"new VarTin("+g(this.name)+", "+g(this.node)+", "+g(this.varlist)+")"},n.prototype.unbox=function(){return this.node?b(this.node,this.varlist):new o(this.name)},n}(),b=function(e,i){var r,u,s,l,a,f;if(m.isArray(e)){if(e.length>0&&e[e.length-1]===t){for(u=Object(),f=e.slice(0,e.length-1),l=0,a=f.length;a>l;l++)r=f[l],u[b(r[0],i)]=b(r[1],i);return u}return d(e,function(n){return b(n,i)})}if(e instanceof n)return e.value;if(e instanceof o){if(void 0!==i){try{s=p(i,e)}catch(c){return e}return null!=s.node&&null!=s.varlist?b(s.node,s.varlist):e}return e}throw"Unrecognized type '"+typeof e+"' in unbox."},f=function(e,i){var r,s;if(e instanceof o){if(null!=i[e.name])if(null!=e.typeFunc&&null!=i[e.name].typeFunc){if(e.typeFunc!==i[e.name].typeFunc)throw"A single variable can not be defined with two diffrent types!"}else null!=e.typeFunc&&(i[e.name].typeFunc=e.typeFunc);else i[e.name]=new u(e.name,null,null,e.typeFunc);return e}if(e instanceof n)return e;if(m.isArray(e))return d(e,function(n){return f(n,i)});if(m.isObj(e)){r=[];for(s in e)r.push([f(s,i),f(e[s],i)]);return r.push(t),r.sort()}return m.isValueType(e||null===e)?new n(e):"Unrecognized type '"+typeof e+"' in box."},a=function(n){var t,e;return n instanceof r?n:(e={},t=f(n,e),new r(t,e))},p=function(n,t){if(!t instanceof o)throw"Node must be a Variable to get_tin!";if(null!=(null!=n?n[t.name]:void 0))return n[t.name];throw"Couldn't find node "+t.name+" in varlist "+n+"!"},s=function(n,t,e,i){var r,u;if(n=n.endOfChain(),!n.isfree())return!1;if(null!==n.typeFunc){if(u=b(t,e),u instanceof o&&o.typeFunc!==n.typeFunc)return!1;if(!n.typeFunc(u))return!1}return n.node=t,n.varlist=e,r=!1,i.push(function(){r||(r=!0,n.node=null,n.varlist=null,n.chainlength=1)}),!0},l=function(n,t,e){return n.isfree()||t.isfree()?n.isfree()&&!t.isfree()?s(n,t.node,t.varlist,e):!n.isfree()&&t.isfree()?s(t,n.node,n.varlist,e):t.chainlength<n.chainlength?(t.chainlength+=1,s(t,null,n,e)):(n.chainlength+=1,s(n,null,t,e)):!1},w=function(t,e,i,r,u){var a,f,c,h,y,d,v;if(null==u&&(u=[]),void 0===t&&void 0===i)return!0;if(null===t&&null===i)return!0;if(null===t||null===i)return!1;if(t instanceof o&&i instanceof o){if(c=p(e,t),h=p(r,i),!l(c,h,u)&&!w(c.node,c.varlist,h.node,h.varlist,u))return!1}else if(t instanceof o){if(c=p(e,t),!s(c,i,r,u)&&!w(c.node,c.varlist,i,r,u))return!1}else if(i instanceof o){if(h=p(r,i),!s(h,t,e,u)&&!w(h.node,h.varlist,t,e,u))return!1}else{if(t instanceof n&&i instanceof n&&m.isValueType(t.value)&&m.isValueType(i.value))return t.value===i.value;if(m.isArray(t)&&m.isArray(i)){if(t.length!==i.length)return!1;for(v=function(){var n,e,i;for(i=[],f=n=0,e=t.length;e>=0?e>=n:n>=e;f=e>=0?++n:--n)i.push(f);return i}(),y=0,d=v.length;d>y;y++)if(a=v[y],!w(t[a],e,i[a],r,u))return!1}}return!0},c("box",a),c("variable",function(n,t){return new o(n,t)}),c("TreeTin",r),c("VarTin",u),c("Box",n),c("DICT_FLAG",t),c("toJson",g),c("Variable",o),c("types",m)}).call(this);