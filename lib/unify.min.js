(function(){var n,t,e,i,r,u,o,s,a,l,f,c,h,p,y,d,v,g,b,m,V,w,F;"undefined"==typeof module&&(window.unify={}),c=function(n,t){return"undefined"==typeof module?window.unify[n]=t:module.exports[n]=t},b=function(n){return n===void 0?"undefined":null===n?"null":""+n},v=function(n,t){var e,i,r,u;for(u=[],i=0,r=n.length;r>i;i++)e=n[i],u.push(t(e));return u},V={isUndef:function(n){return n===void 0},isBool:function(n){return"boolean"==typeof n},isArray:function(n){return null!=n&&Array.isArray(n)},isStr:function(n){return"string"==typeof n},isNum:function(n){return"number"==typeof n},isObj:function(n){return null!==n&&!V.isArray(n)&&"object"==typeof n},isValueType:function(n){return V.isBool(n)||V.isStr(n)||V.isNum(n)},isFunc:function(n){return!!(n&&n.constructor&&n.call&&n.apply)}};for(d in V)V[d].maxDepth=1;m=function(n){var t,e;return V.isArray(n)?"["+v(n,function(n){return m(n)}).join()+"]":V.isStr(n)?'"'+n+'"':(e=b(n),V.isObj(n)&&"[object Object]"===e?"{"+function(){var e;e=[];for(t in n)e.push(t+":"+m(n[t]));return e}().join()+"}":e)},e=function(){function n(){}return n.prototype.toString=function(){return"DICT_FLAG"},n}(),t=new e,n=function(){function n(n){if(!V.isValueType(n)&&null!==n)throw"Can only box value types, not "+m(n);this.value=n}return n.prototype.toString=function(){return m(this.value)},n}(),h=1,i="__HIDDEN__",y=function(n){return n.substring(0,i.length)===i},o=function(){function n(n,t){this.typeFunc=null!=t?t:null,this.isListVar="$"===n[0],this.isListVar&&(n=n.substring(1)),"_"===n?(this.name=i+h,h+=1):this.name=n}return n.prototype.isHiddenVar=function(){return y(this.name)},n.prototype.toString=function(){return"Variable("+m(this.name)+")"},n}(),r=function(){function n(n,t){this.node=n,this.varlist=t,this.changes=[]}return n.prototype.toString=function(){return m(this.node)},n.prototype.get=function(n,t){var e;if(e=this.varlist[n],!e)throw"Variable "+n+" not in this tin";return e=e.endOfChain(),e.node?w(e.node,e.varlist,t):new o(e.name)},n.prototype.getAll=function(n){var t,e;t={};for(e in this.varlist)y(e)||(t[e]=this.get(e,n));return t},n.prototype.unbox=function(n){return w(this.node,this.varlist,n)},n.prototype.unify=function(t){var e,i;return e=[],t instanceof n||(t=l(t)),i=F(this.node,this.varlist,t.node,t.varlist,e),i?(this.changes.push.apply(this.changes,e),this.changes.push.apply(t.changes,e),[this,t]):(v(e,function(n){return n()}),null)},n.prototype.bind=function(t,e){var i,r;return r=this.varlist[t].endOfChain(),r.isfree()?(e instanceof n||(e=l(e)),i=[],s(r,e.node,e.varlist,i)?(this.changes.push.apply(this.changes,i),this.changes.push.apply(e.changes,i),[this,e]):null):null},n.prototype.rollback=function(){v(this.changes,function(n){return n()}),this.changes.splice(0,this.changes.length)},n}(),u=function(){function n(n,t,e,i){this.name=n,this.node=null!=t?t:null,this.varlist=null!=e?e:null,this.typeFunc=null!=i?i:null,this.chainlength=1}return n.prototype.endOfChain=function(){var t;for(t=this;t.varlist instanceof n;)t=t.varlist;return t},n.prototype.isfree=function(){var n;return n=this.endOfChain(),null===n.node&&null===n.varlist},n.prototype.isHiddenVar=function(){return y(this.name)},n.prototype.toString=function(){return"VarTin("+m(this.name)+")"},n.prototype.unbox=function(n){return this.node?w(this.node,this.varlist,n):new o(this.name)},n}(),w=function(e,i,r){var u,s,a,l,f,c;if(null==r&&(r=-1),0===r)return e;if(V.isArray(e)){if(e.length>0&&e[e.length-1]===t){for(s=Object(),c=e.slice(0,e.length-1),l=0,f=c.length;f>l;l++)u=c[l],s[w(u[0],i,r-1)]=w(u[1],i,r-1);return s}return v(e,function(n){return w(n,i,r-1)})}if(e instanceof n)return e.value;if(e instanceof o){if(void 0!==i){try{a=p(i,e)}catch(h){return e}return null!=a.node&&null!=a.varlist?w(a.node,a.varlist,r-1):e}return e}throw"Unrecognized type '"+typeof e+"' in unbox."},f=function(e,i){var r,s,a,l;if(e instanceof o){if(null!=i[e.name])if(null!=e.typeFunc&&null!=i[e.name].typeFunc){if(e.typeFunc!==i[e.name].typeFunc)throw"A single variable can not be defined with two diffrent types!"}else null!=e.typeFunc&&(i[e.name].typeFunc=e.typeFunc);else i[e.name]=new u(e.name,null,null,e.typeFunc);return e}if(e instanceof n)return e;if(V.isArray(e))return s=!1,l=v(e,function(n){if(n instanceof o&&n.isListVar){if(s)throw"There can only be one list variable in an array!";s=!0}return f(n,i)}),l.hasListVar=s,l;if(V.isObj(e)){r=[];for(a in e)r.push([f(a,i),f(e[a],i)]);return r.push(t),r.sort()}return V.isValueType(e||null===e)?new n(e):"Unrecognized type '"+typeof e+"' in box."},l=function(n){var t,e;return n instanceof r?n:(e={},t=f(n,e),new r(t,e))},p=function(n,t){if(!t instanceof o)throw"Node must be a Variable to get_tin!";if(null!=(null!=n?n[t.name]:void 0))return n[t.name];throw"Couldn't find node "+t.name+" in varlist "+n+"!"},s=function(n,t,e,i){var r,u;if(n=n.endOfChain(),!n.isfree())return!1;if(null!==n.typeFunc){if(u=w(t,e,n.typeFunc.maxDepth),u instanceof o&&o.typeFunc!==n.typeFunc)return!1;if(!n.typeFunc(u))return!1}return n.node=t,n.varlist=e,r=!1,i.push(function(){r||(r=!0,n.node=null,n.varlist=null,n.chainlength=1)}),!0},a=function(n,t,e){return n.isfree()||t.isfree()?n.isfree()&&!t.isfree()?s(n,t.node,t.varlist,e):!n.isfree()&&t.isfree()?s(t,n.node,n.varlist,e):t.chainlength<n.chainlength?(t.chainlength+=1,s(t,null,n,e)):(n.chainlength+=1,s(n,null,t,e)):!1},F=function(t,e,i,r,u){var l,f,c,h,y,d,v;if(null==u&&(u=[]),void 0===t&&void 0===i)return!0;if(null===t&&null===i)return!0;if(null===t||null===i)return!1;if(t instanceof o&&i instanceof o)return d=p(e,t),v=p(r,i),a(d,v,u)?!0:F(d.node,d.varlist,v.node,v.varlist,u);if(t instanceof o)return d=p(e,t),s(d,i,r,u)?!0:F(d.node,d.varlist,i,r,u);if(i instanceof o)return F(i,r,t,e,u);if(t instanceof n&&i instanceof n)return t.value===i.value;if(V.isArray(t)&&V.isArray(i)){if(h=t.length-(t.hasListVar?1:0),y=i.length-(i.hasListVar?1:0),h===y){if(t.hasListVar&&(t=g(t,e,u),!t))return!1;if(i.hasListVar&&(i=g(i,r,u),!i))return!1;for(l=0;t.length>l;){if(!F(t[l],e,i[l],r,u))return!1;l++}return!0}if(h>y)return F(i,r,t,e,u);if(i=g(i,r,u),!i)return!1;for(f=0,c=0;i.length>c;){if(t[f]instanceof o&&t[f].isListVar){if(!F(t[f],e,i.slice(c,c+y-h),r,u))return!1;c+=y-h-1}else if(!F(t[f],e,i[c],r,u))return!1;f++,c++}return!0}return t===i},g=function(n,t,e){var i,r,u,s;for(r=[],u=0,s=n.length;s>u;u++)if(i=n[u],i instanceof o&&i.isListVar){if(!F(i,t,[],[],e))return!1}else r.push(i);return r},c("box",l),c("variable",function(n,t){return new o(n,t)}),c("TreeTin",r),c("VarTin",u),c("Box",n),c("DICT_FLAG",t),c("toJson",m),c("Variable",o),c("types",V)}).call(this);