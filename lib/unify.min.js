(function(){var Box,DICT_FLAG,DictFlag,HIDDEN_VAR_PREFIX,Tin,Variable,bind,bind_tins,box,boxit,extern,g_hidden_var_counter,get_tin,isHiddenVar,isarray,isbool,isfunc,isnum,isobj,isstr,isundef,isvaluetype,str,toJson,unboxit,unify,_unify;typeof module=="undefined"&&(window.JSUnify={}),extern=function(name,o){return typeof module=="undefined"?window.JSUnify[name]=o:module.exports[name]=o},str=function(o){return typeof o=="undefined"?"undefined":o===null?"null":o.toString()},isundef=function(o){return typeof o=="undefined"},isbool=function(o){return typeof o=="boolean"},isarray=function(o){return o!=null&&Array.isArray(o)},isstr=function(o){return typeof o=="string"},isnum=function(o){return typeof o=="number"},isobj=function(o){return o!==null&&!isarray(o)&&typeof o=="object"},isvaluetype=function(o){return isbool(o)||isstr(o)||isnum(o)},isfunc=function(o){return!!(o&&o.constructor&&o.call&&o.apply)},toJson=function(elem){var e;return isarray(elem)?"["+function(){var _i,_len,_results;_results=[];for(_i=0,_len=elem.length;_i<_len;_i++)e=elem[_i],_results.push(toJson(e));return _results}().join(",")+"]":elem instanceof Box||elem instanceof Tin||elem instanceof Variable||elem instanceof DictFlag?str(elem):isobj(elem)?"{"+function(){var _results;_results=[];for(e in elem)_results.push(e+":"+toJson(elem[e]));return _results}().join(",")+"}":isstr(elem)?'"'+elem+'"':str(elem)},DictFlag=function(){function DictFlag(){}return DictFlag.prototype.toString=function(){return"new DictFlag()"},DictFlag}(),DICT_FLAG=new DictFlag,Box=function(){function Box(v){if(!isvaluetype(v)&&v!==null)throw"Can only box value types, not "+toJson(v);this.value=v}return Box.prototype.toString=function(){return"new Box("+toJson(this.value)+")"},Box}(),g_hidden_var_counter=1,HIDDEN_VAR_PREFIX="__B3qgfO__",isHiddenVar=function(name){return name.slice(0,HIDDEN_VAR_PREFIX.length)===HIDDEN_VAR_PREFIX},Variable=function(){function Variable(name){name==="_"?(this.name=HIDDEN_VAR_PREFIX+g_hidden_var_counter,g_hidden_var_counter+=1):this.name=name}return Variable.prototype.isHiddenVar=function(){return isHiddenVar(this.name)},Variable.prototype.toString=function(){return"variable("+toJson(this.name)+")"},Variable}(),Tin=function(){function Tin(name,node,varlist){this.node=node!=null?node:null,this.varlist=isobj(varlist)?varlist:null,this.chainlength=1,this.name=name,this.changes=[]}return Tin.prototype.end_of_chain=function(){var t;t=this;while(t.varlist instanceof Tin)t=t.varlist;return t},Tin.prototype.isfree=function(){var t;return t=this.end_of_chain(),t.node===null&&t.varlist===null},Tin.prototype.isHiddenVar=function(){return isHiddenVar(this.name)},Tin.prototype.toString=function(){return"new Tin("+toJson(this.name)+", "+toJson(this.node)+", "+toJson(this.varlist)+")"},Tin.prototype.get=function(var_name){var n,vartin;vartin=this.varlist[var_name],vartin!==null&&vartin!==void 0&&(vartin=vartin.end_of_chain());if(vartin==null)throw"Variable "+var_name+" not in this tin";if(vartin.node==null||vartin.node===null)return new Variable(vartin.name);if(vartin.node instanceof Box)return unboxit(vartin.node,vartin.varlist);if(vartin.node instanceof Variable)return unboxit(vartin.node,vartin.varlist);if(isarray(vartin.node))return function(){var _i,_len,_ref,_results;_ref=vartin.node,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)n=_ref[_i],_results.push(unboxit(n,vartin.varlist));return _results}();throw"Unknown type in get"},Tin.prototype.get_all=function(){var j,key;j={};for(key in this.varlist)isHiddenVar(key)||(j[key]=this.get(key));return j},Tin.prototype.unbox=function(){return unboxit(this.node)},Tin.prototype.unify=function(expr){var changes,ret;return changes=[],ret=unify(this,expr,changes),ret&&(ret[0].changes.push.apply(ret[0].changes,changes),ret[1].changes.push.apply(ret[1].changes,changes)),ret},Tin.prototype.rollback=function(){var change,_i,_len,_ref,_results;_ref=this.changes,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)change=_ref[_i],_results.push(change());return _results},Tin}(),boxit=function(elem,tinlist){var a,item,key;if(elem instanceof Variable)return tinlist!=null&&(tinlist[elem.name]=new Tin(elem.name,null,null)),elem;if(elem instanceof Box)return elem;if(isarray(elem))return function(){var _i,_len,_results;_results=[];for(_i=0,_len=elem.length;_i<_len;_i++)item=elem[_i],_results.push(boxit(item,tinlist));return _results}();if(isobj(elem)){a=[];for(key in elem)a.push([boxit(key,tinlist),boxit(elem[key],tinlist)]);return a.push(DICT_FLAG),a.sort()}if(isvaluetype(elem||elem===null))return new Box(elem);throw"Don't understand the type of elem"},unboxit=function(tree,varlist){var e,hash,item,tin,_i,_len,_ref;if(isarray(tree)){if(tree[tree.length-1]===DICT_FLAG){hash=new Object,_ref=tree.slice(0,tree.length-1);for(_i=0,_len=_ref.length;_i<_len;_i++)e=_ref[_i],hash[unboxit(e[0])]=unboxit(e[1]);return hash}return function(){var _j,_len1,_results;_results=[];for(_j=0,_len1=tree.length;_j<_len1;_j++)item=tree[_j],_results.push(unboxit(item));return _results}()}if(tree instanceof Box)return tree.value;if(tree instanceof Variable){if(varlist!==void 0){try{tin=get_tin(varlist,tree)}catch(error){return tree}return unboxit(tin.node,tin.varlist)}return tree}throw"Unrecognized type '"+typeof tree+"' in unboxit"},box=function(elem){var tinlist,tree;return elem instanceof Tin?elem:(tinlist={},tree=boxit(elem,tinlist),new Tin(null,tree,tinlist))},get_tin=function(varlist,node){if(!node instanceof Variable)throw"Node must be a Variable to get_tin";if((varlist!=null?varlist[node.name]:void 0)!=null)return varlist[node.name];throw"Couldn't find node "+node.name+" in varlist "+varlist},bind=function(t,node,varlist,changes){var called;return t=t.end_of_chain(),t.isfree()?(t.node=node,t.varlist=varlist,called=!1,changes.push(function(){if(called)return;called=!0,t.node=null,t.varlist=null,t.chainlength=1})):!1},bind_tins=function(t1,t2,changes){return!t1.isfree()&&!t2.isfree()?!1:t1.isfree()&&!t2.isfree()?bind(t1,t2.node,t2.varlist,changes):!t1.isfree()&&t2.isfree()?bind(t2,t1.node,t1.varlist,changes):t2.chainlength<t1.chainlength?(t2.chainlength+=1,bind(t2,null,t1,changes)):(t1.chainlength+=1,bind(t1,null,t2,changes))},unify=function(expr1,expr2,changes){var success;return changes==null&&(changes=[]),success=!0,expr1=expr1 instanceof Tin?expr1:box(expr1),expr2=expr2 instanceof Tin?expr2:box(expr2),success=_unify(expr1.node,expr1.varlist,expr2.node,expr2.varlist,changes),success===!1?null:[expr1,expr2]},_unify=function(n1,v1,n2,v2,changes){var idx,num,t1,t2,_i,_len,_ref;changes==null&&(changes=[]);if(n1===void 0&&n2===void 0)return!0;if(n1===null&&n2===null)return!0;if(n1===null||n2===null)return!1;if(n1 instanceof Variable&&n2 instanceof Variable){t1=get_tin(v1,n1),t2=get_tin(v2,n2);if(!bind_tins(t1,t2,changes)&&!_unify(t1.node,t1.varlist,t2.node,t2.varlist,changes))return!1}else if(n1 instanceof Variable){t1=get_tin(v1,n1);if(!bind(t1,n2,v2,changes)&&!_unify(t1.node,t1.varlist,n2,v2,changes))return!1}else if(n2 instanceof Variable){t2=get_tin(v2,n2);if(!bind(t2,n1,v1,changes)&&!_unify(t2.node,t2.varlist,n1,v1,changes))return!1}else{if(n1 instanceof Box&&n2 instanceof Box&&isvaluetype(n1.value)&&isvaluetype(n2.value))return n1.value===n2.value;if(isarray(n1)&&isarray(n2)){if(n1.length!==n2.length)return!1;_ref=function(){var _j,_ref,_results;_results=[];for(num=_j=0,_ref=n1.length;0<=_ref?_j<=_ref:_j>=_ref;num=0<=_ref?++_j:--_j)_results.push(num);return _results}();for(_i=0,_len=_ref.length;_i<_len;_i++){idx=_ref[_i];if(!_unify(n1[idx],v1,n2[idx],v2,changes))return!1}}}return!0},extern("box",box),extern("variable",function(name){return new Variable(name)}),extern("Tin",Tin),extern("Box",Box),extern("DICT_FLAG",DICT_FLAG),extern("toJson",toJson),extern("Variable",Variable)}).call(this)